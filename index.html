<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpinkTweet - Real-time Communication</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    .messages {
      background-color: white;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }
    .message {
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .message .sender {
      font-weight: bold;
    }
    .message .content {
      margin-top: 5px;
    }
    .input-container {
      display: flex;
      justify-content: space-between;
    }
    .input-container input {
      width: 80%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .input-container button {
      width: 15%;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .input-container button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SpinkTweet Communication</h1>
    <div class="messages" id="messages">
      <!-- Messages will be dynamically inserted here -->
    </div>
    <div class="input-container">
      <input type="text" id="messageInput" placeholder="Type your message..." />
      <button id="sendMessageBtn">Send</button>
    </div>
  </div>

  <!-- Firebase SDK and App Configuration -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-messaging.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDWDk_p33Y_jgPNJPHoJApEmo0W7Q9BhxA",
      authDomain: "spinktweet.firebaseapp.com",
      projectId: "spinktweet",
      storageBucket: "spinktweet.firebasestorage.app",
      messagingSenderId: "848866063079",
      appId: "1:848866063079:web:be2efce9b4c5ecc3956842",
      measurementId: "G-81YMX6VBK4"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);
    const messaging = firebase.messaging(app);

    // Real-time message sync from Firestore
    const messagesRef = db.collection("messages");

    const renderMessage = (message) => {
      const messageDiv = document.createElement("div");
      messageDiv.className = "message";
      messageDiv.innerHTML = `
        <div class="sender">${message.sender}</div>
        <div class="content">${message.message}</div>
      `;
      document.getElementById("messages").appendChild(messageDiv);
    };

    const listenForMessages = () => {
      messagesRef.orderBy("timestamp", "asc").onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === "added") {
            renderMessage(change.doc.data());
          }
        });
      });
    };

    // Send message to Firestore
    const sendMessage = () => {
      const messageInput = document.getElementById("messageInput");
      const message = messageInput.value;
      if (message.trim() === "") return;

      messagesRef.add({
        sender: "Oliver", // Replace with dynamic user name if needed
        message: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        messageInput.value = ""; // Clear input
      }).catch((error) => {
        console.error("Error adding message:", error);
      });
    };

    // Set up message sending
    document.getElementById("sendMessageBtn").addEventListener("click", sendMessage);

    // Enable FCM for notifications
    const requestPermission = async () => {
      try {
        const token = await messaging.getToken({
          vapidKey: "YOUR_VAPID_KEY" // Replace with your own VAPID key
        });
        console.log("FCM Token:", token);
        // You can store this token in Firestore to target specific users
      } catch (error) {
        console.error("Error getting FCM token:", error);
      }
    };

    messaging.onMessage((payload) => {
      console.log("Message received:", payload);
      // Show the notification when app is in the foreground
      new Notification("New Message", {
        body: payload.notification.body,
      });
    });

    // Request permission for notifications
    requestPermission();

    // Start listening for messages
    listenForMessages();
  </script>

  <script>
    // Service Worker Registration
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js").then((registration) => {
        console.log("Service Worker registered:", registration);
      }).catch((error) => {
        console.log("Service Worker registration failed:", error);
      });
    }
  </script>
</body>
</html>
